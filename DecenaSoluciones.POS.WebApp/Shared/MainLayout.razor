@using BlazorBootstrap
@using DecenaSoluciones.POS.Shared.Dtos;
@using DecenaSoluciones.POS.WebApp.Extensions;
@using DecenaSoluciones.POS.WebApp.Pages;
@using DecenaSoluciones.POS.WebApp.Pages.Components;
@using Microsoft.AspNetCore.Components.Authorization;
@using DecenaSoluciones.POS.Shared.Extensions;
@inherits LayoutComponentBase

@inject AuthenticationStateProvider autenticacionProvider
@inject NavigationManager navManager
@inject ILocalStorage _localStorage

<div class="bb-page">
    <NavMenu />

    <main>
        <AuthorizeView>
            <div class="bb-top-row px-4 d-flex justify-content-end bg-white border-bottom shadow-sm">
                <Dropdown>
                    <DropdownToggleButton Color="ButtonColor.Light" Size="Size.Small"
                        Class="d-flex align-items-center gap-2 border-0">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-2 text-primary">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <span class="fw-medium">@context.User.Identity!.Name</span>
                    </DropdownToggleButton>
                    <DropdownMenu Class="shadow border-0 mt-2">
                        <DropdownItem To="#" Type="BlazorBootstrap.ButtonType.Link"
                        @onclick="(() => ShowChangePasswordModal(context.User.Identity?.Name ?? string.Empty))"
                            href="javascript:void(0)" Class="py-2">
                            <i class="bi bi-key me-2"></i> Cambiar contraseña
                        </DropdownItem>
                        <DropdownDivider />
                        <DropdownItem To="#" Type="BlazorBootstrap.ButtonType.Link" @onclick="CerrarSesion"
                            href="javascript:void(0)" Class="py-2 text-danger">
                            <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesión
                        </DropdownItem>
                    </DropdownMenu>
                </Dropdown>
            </div>
        </AuthorizeView>

        <article class="content px-4 py-4">
            @Body
        </article>
    </main>

</div>


<Modal @ref="changePasswordModal" UseStaticBackdrop="true" Size="ModalSize.Regular" />

@code {
    private Modal changePasswordModal = default!;

    private async Task ShowChangePasswordModal(string userName)
    {
        var parameters = new Dictionary<string, object>();
        parameters.Add("userName", userName);
        parameters.Add("OnClose", EventCallback.Factory.Create<MouseEventArgs>(this, HideChangePasswordModal));
        await changePasswordModal.ShowAsync<ChangePasswordComponent>(title: $"Actualizar Contraseña", parameters: parameters);
    }

    private async Task HideChangePasswordModal(MouseEventArgs e)
    {
        await changePasswordModal.HideAsync();
    }

    private async Task CerrarSesion()
    {
        var autenticacionExt = (AuthExtension)autenticacionProvider;
        await autenticacionExt.UpdateSessionState(string.Empty);
        navManager.NavigateTo("/Login", true);
    }
}

<Preload />